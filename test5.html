<!--

next up:

add a debug tree to show the model

//move all model manipulation code to separate module. start using browserify
//build unit tests
//description of the data structure and operations


//model nodes have ref to parent. should simplify model manipulation code
//model has function to change style on a node

model has function to load a new model
model has function to fetch model as JSON

//util function for deleting children from a DOM node

make a wrapper function which saves selection, executes action, syncs the dom, then updates selection again

handle the case where you delete a selection across block boundaries
special case enter key inside of a code block
special case tab key inside of code block: indent/outdent

make prettier styles
add semantic type style using after:content: css

redo demo layout with proper scrolling, flexbox, etc.

remove duplicate change events. should just be add, delete, and text


abstract keyboard handling into a separate class.
attach commands to keystrokes with a map

implement making a link with command-shift-A
invokes a callback to open a dialog and set the result.

implement list support
    switch block type to list item
    enter to make next list item
    switch from numbered to bulleted items
    indent/outdent

implement a model extension for images and other embedded media. forms, etc.


more content types:
blockquote
several header levels: title, subtitle, section


-->


<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Semantic Editor</title>

    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.css"/>
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap-theme.css"/>
    <link rel="stylesheet" href="semantic.css"/>
    <link rel="stylesheet" href="visual.css"/>
    <link rel="stylesheet" href="markdown.css"/>
    <style type='text/css'>

#editor {
    border: 1px dotted #ddd;
    padding: 0.5em;
    margin: 1em 0em;
}
#editor:focus {
    outline: none;
    border: 1px solid #ddd;
}

#key-docs {
    border: 1px solid #888;
    border-collapse: collapse;
}
#key-docs td {
    padding: 0.25em 0.25em;
    border: 1px solid #ccc;
}

#model-tree ul {
    padding-left: 2em;
}
#model-tree > ul {
    padding-left: 0;
}

</style>

</head>
<body>

    <div class="container">
        <div class="row">
            <h3>Semantic Editor</h3>
        </div>
        <div class="row">
            <div class="col-md-3">
                <h3>Shortcuts</h3>
                <table id="key-docs"></table>
            </div>
            <div class="col-md-6">
                <div class="row">
                    <div class="col-md-12">
                        <div class="btn-group">
                            <button id="foo" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Block <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a href="#" id="set-header">Header</a></li>
                                <li><a href="#" id="set-subheader">Subheader</a></li>
                                <li><a href="#" id="set-body">Plain Body</a></li>
                                <li><a href="#" id="set-block-code">Code Block</a></li>
                                <li><a href="#" id="set-block-quote">Quote</a></li>
                                <li><a href="#" id="set-list-item">List Item</a></li>
                                <li role="separator" class="divider"></li>
                                <li><a href="#" id="set-custom">Custom</a></li>
                            </ul>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Span <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a href="#" id="set-plain">Plain</a></li>
                                <li><a href="#" id="set-bold">Bold</a></li>
                                <li><a href="#" id="set-italic">Italic</a></li>
                                <li><a href="#" id="set-inline-code">Code</a></li>
                                <li><a href="#" id="set-inline-link">Link</a></li>
                                <li><a href="#" id="set-inline-subscript">Subscript</a></li>
                                <li><a href="#" id="set-inline-superscript">Superscript</a></li>
                                <li><a href="#" id="set-deleted">Deleted</a></li>
                                <li role="separator" class="divider"></li>
                                <li><a href="#" id="set-custom-inline">Custom</a></li>
                            </ul>
                        </div>
                        <div class="btn-group">
                            <button id='switch-semantic' type="button" class="btn btn-default">Semantic</button>
                            <button id='switch-visual' type="button" class="btn btn-default">Visual</button>
                            <button id='switch-markdown' type="button" class="btn btn-default">Markdown</button>
                        </div>
                    </div>
                </div>
                <div id="current-style">current style</div>
                <div id="editor" class="semantic-view" contenteditable="true" spellcheck="false"></div>
            </div>
            <div class="col-md-3">
                <h3>Tree Structure</h3>
                <div id="model-tree"></div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="link-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Edit Link</h4>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label>Text</label> <input type="text" class="form-control" id="link-modal-text"/>
                            <label>Link</label> <input type="text" class="form-control" id="link-modal-url"/>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="link-modal-submit">Insert</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

</body>
<script src="node_modules/jquery/dist/jquery.js"></script>
<script src="node_modules/bootstrap/dist/js/bootstrap.js"></script>
<script src="bundle.js"></script>
<script type='text/javascript'>

var doc = require('model');
var model = doc.makeModel();
model.setStyles({
    block:{
        //name of style : css classname
        header:'header',
        subheader:'subheader',
        body:'body',
        'block-code':'block-code',
        'block-quote':'block-quote'
    },
    inline: {
        bold:'bold',
        italic:'italic',
        'inline-code':'inline-code',
        link:'link',
        subscript:'subscript',
        superscript:'superscript'
    }
});


var browser_keymap = {
    8:"backspace",
    13:"enter",
    37:"arrow-left",
    39:"arrow-right",
    38:"arrow-up",
    40:"arrow-down",
    65:"a",
    66:"b",
    67:"c",
    68:"d",
    73:"i"
};

var key_to_actions = {
    "arrow-left": "update-current-style",
    "arrow-right": "update-current-style",
    "arrow-up": "update-current-style",
    "arrow-down": "update-current-style",
    "ctrl-d":"delete-forward",
    "cmd-b":"style-bold",
    "backspace":"delete-backward",
    "cmd-i":"style-italic",
    "cmd-shift-c":"style-inline-code",
    "cmd-shift-a":"style-inline-link",
};


var block1 = model.makeBlock();
model.setBlockStyle(block1,'header');
var text1 = model.makeText("This is a header");
block1.append(text1);
var text2 = model.makeText(" with some");
block1.append(text2);
var text3 = model.makeText(" text");
block1.append(text3);
model.getRoot().append(block1);

var block2 = model.makeBlock();
model.getRoot().append(block2);
model.setBlockStyle(block2,'body');
block2.append(model.makeText("This is a paragraph of body text"));


var span1 = model.makeSpan();
span1.style = 'bold';
span1.append(model.makeText(" with some bold"));
block2.append(span1);

var span2 = model.makeSpan();
span2.style = 'italic';
span2.append(model.makeText(" and italic"));
block2.append(span2);

block2.append(model.makeText(" text to read."));
block2.append(model.makeText(" And now some more text that we will read and read and it just goes on and on."));

var block3 = model.makeBlock();
model.getRoot().append(block3);
model.setBlockStyle(block3,'body');
//block3.append(model.makeText("This is another paragraph of body text"));
block3.append(model.makeText("T"));


var block3 = model.makeBlock();
model.getRoot().append(block3);
model.setBlockStyle(block3,'block-code');
block3.append(model.makeText("//codeblock\nfor(var i=0; i<8; i++) {\n  console.log(i);\n}"));

var editor = document.getElementById('editor');

function syncDom(editor,model) {
    renderTree(model);
    while (editor.firstChild) {
        editor.removeChild(editor.firstChild);
    }
    model.getRoot().content.forEach(function (block) {
        var blockElement = document.createElement('div');
        blockElement.id = block.id;
        blockElement.classList.add(block.style);
        block.content.forEach(function (inline) {
            if (inline.type == doc.TEXT) {
                blockElement.appendChild(document.createTextNode(inline.text));
            }
            if (inline.type == doc.SPAN) {
                var elem = document.createElement('span');
                if(inline.meta && inline.meta.elementName == 'A') {
                    elem = document.createElement('a');
                    if(inline.meta.href) {
                        elem.setAttribute("href",inline.meta.href);
                        elem.setAttribute("title",inline.meta.href);
                        setTimeout(function() {
                            $('#'+inline.id).tooltip({
                                container:'body'
                            });
                        },100);
                    }
                }
                elem.id = inline.id;
                elem.classList.add(inline.style);
                elem.appendChild(document.createTextNode(inline.child(0).text));
                blockElement.appendChild(elem);
            }
        });
        editor.appendChild(blockElement);
    });
}

syncDom(editor,model);

function clearChildren(root) {
    while (root.firstChild) root.removeChild(root.firstChild);
}

function renderTree(model) {
    var root = document.getElementById("model-tree");
    clearChildren(root);
    root.appendChild(renderTreeChild(model.getRoot()));
}

function renderTreeChild(mnode) {
    var ul = document.createElement('ul');
    for(var i=0; i<mnode.childCount(); i++) {
        var li = document.createElement('li');

        var child = mnode.child(i);
        var text = child.type + " " + child.id;
        li.appendChild(document.createTextNode(text));
        if(child.type == doc.TEXT) {
            li.appendChild(document.createTextNode(': "'+child.text+'"'));
        }
        if(child.childCount() > 0) {
            var child_dom = renderTreeChild(child);
            li.appendChild(child_dom);
        }
        ul.appendChild(li);
    }
    return ul;
}

function findParentNonTextNode(node) {
    var path = [];
    while(node.nodeType == Node.TEXT_NODE || node.id == "") {
        var parent = node.parentNode;
        var nn = -1;
        for(var i=0; i<parent.childNodes.length; i++) {
            if(parent.childNodes[i] == node) {
                nn = i;
            }
        }
        path.unshift(nn);
        node = parent;
    }
    return {
        node:node,
        path:path
    }
}

function saveSelection(ed,model) {
    var sel = window.getSelection();
    var range = sel.getRangeAt(0);
    var start = findParentNonTextNode(range.startContainer);
    var end = findParentNonTextNode(range.endContainer);
    return {
        id:start.node.id,
        path:start.path,
        startOffset:range.startOffset,
        endid: end.node.id,
        endpath: end.path,
        endOffset:range.endOffset,
        collapsed:range.collapsed,
        startpos: {
            id:start.node.id,
            path:start.path,
            offset:range.startOffset,
            model:model
        },
        endpos: {
            id: end.node.id,
            path:end.path,
            offset:range.endOffset,
            model:model
        }
    };
}

function restoreSelection(ran) {
    if(!ran.id || ran.id == "") {
        console.log("WARNING. bad id");
        return;
    }
    var range = document.createRange();
    var node = document.getElementById(ran.id);
    ran.path.forEach(function(index){
        node = node.childNodes[index];
    });
    range.setStart(node, ran.startOffset);
    range.collapse(true);
    var wsel = window.getSelection();
    wsel.removeAllRanges();
    wsel.addRange(range);
}

function setSelection(node, index, model) {
    var range = document.createRange();
    //text dom nodes don't have an id, so move up a level
    if(node.type == doc.TEXT) { node = node.getParent(); }
    var dom_node = document.getElementById(node.id);
    range.setStart(dom_node,index);
    range.collapse(true);
    var wsel = window.getSelection();
    wsel.removeAllRanges();
    wsel.addRange(range);
}

function genModelFromDom(node) {
    if(node.nodeType == Element.TEXT_NODE) {
        return {
            id:doc.genId(),
            type:'text',
            content: node.nodeValue
        }
    }
    if(node.nodeType == Element.ELEMENT_NODE) {
        var content = [];
        for(var i=0; i<node.childNodes.length; i++) {
            content.push(genModelFromDom(node.childNodes[i]));
        }
        var style = 'bold';
        var type = 'inline';
        if(Array.prototype.indexOf.call(node.classList,'italic') >= 0) {
            type = 'inline';
            style = 'italic';
        }
        if(Array.prototype.indexOf.call(node.classList,'header') >= 0) {
            style = 'header';
            type = 'block';
        }
        return {
            id:doc.genId(),
            type:type,
            style:style,
            content:content
        }
    }
    console.log("ERROR. UNSUPPORTED NODE TYPE",node.nodeType,node);
}

function applyChanges(editor,model,changes) {
    changes.forEach(function(ch){
        if(ch.type=='text') {
            ch.model_node.text = ch.new_text;
        }
        if(ch.type == 'append') {
            if(ch.dom_node.nodeType == Element.ELEMENT_NODE) {
                ch.model.push(genModelFromDom(ch.dom_node));
            }
            if(ch.dom_node.nodeType == Element.TEXT_NODE) {
                ch.model.push(genModelFromDom(ch.dom_node));
            }
        }
        if(ch.type == 'remove'){
            ch.model.splice(ch.mod_i,1);
        }
        if(ch.type == 'delete'){
             ch.model.content.splice(ch.mod_i,1);
        }
        if(ch.type == 'insert') {
            var mod = genModelFromDom(ch.dom_node);
            ch.model.splice(ch.mod_i,0,mod);
        }
        if(ch.type == 'transform') {
            console.log("got a transform");
            if(ch.model_node.type == 'block') {
                console.log("node name = ", ch.dom_node.nodeName);
                if(ch.dom_node.nodeName == 'BR') {
                    console.log("switched to a BR. this is really a deletion");
                    var parent = ch.model_node.getParent();
                    var n = parent.content.indexOf(ch.model_node);
                    parent.content.splice(n,1);
                }
            }
        }
    });
}

var u = {
    incount: 0,
    genTab: function() {
        var str = "";
        for(var i=0; i<this.incount; i++) str += "  ";
        return str;
    },
    p: function(s) {
        console.log(this.genTab()+""+s);
    },
    indent: function() {
        this.incount++;
    },
    outdent: function() {
        this.incount--;
    }
};

function scanForChanges(dom_root,mod_root) {
    var changes = [];
    if(dom_root.childNodes.length != mod_root.childCount()) {
        u.p("WARNING: length has changed");
    }

    //do children first
    var dom_i = 0;
    var dom_len = dom_root.childNodes.length;
    var mod_i = 0;
    var mod_len = mod_root.childCount();
    if(mod_len > 0 && dom_len > 0) {
        while(true) {
            var dom_node = dom_root.childNodes[dom_i];
            var mod_node = mod_root.child(mod_i);
            //if next dom matches current node, then a new node was inserted
            //if cur dom matches next model, then a node was deleted
            if(dom_node.nodeType == Node.ELEMENT_NODE) {
                if(dom_node.id != mod_node.id) {
                    //console.log("element mismatch",dom_node,mod_node,mod_node.id);
                    if(mod_i+1 < mod_len) {
                        var next_mod = mod_root.child(mod_i+1);
                    }
                    if(dom_i+1 < dom_len) {
                        var next_dom = dom_root.childNodes[dom_i+1];
                        if(next_dom.id == mod_node.id) {
                            //u.p("a new item was inserted");
                        }
                    }
                    if(next_mod && next_dom) {
                        if(next_mod.id == next_dom.id) {
                            //console.log("next is the same. just this is different");
                            changes.push({
                                type:'transform',
                                model_node:mod_node,
                                model_index:mod_i,
                                dom_node:dom_node,
                                dom_index:dom_i
                            })
                        }
                    }
                }
            }
            if(mod_i+1 < mod_len) {
                var next_mod = mod_root.child(mod_i+1);
                if(next_mod.id == dom_node.id) {
                    //u.p("next matchup");
                }
            }
            changes = changes.concat(scanForChanges(dom_node,mod_node));


            mod_i++;
            dom_i++;
            if(mod_i >= mod_len || dom_i >= dom_len ) break;
        }
        if(mod_i < mod_len) {
             changes.push({
                type:'delete',
                model:mod_root,
                mod_i:mod_i
            });
        }
        if(dom_i < dom_len) {
            //u.p("there was an extra dom node. Insertion");
        }
    }
    if(dom_len == 0 && mod_len > 0) {
        //u.p("too many model nodes. must delete them");
        changes.push({
            type:'delete',
            model:mod_root,
            mod_i:0
        })
    }

    //node itself
    if(dom_root.nodeType == Node.TEXT_NODE) {
        if(mod_root.text != dom_root.nodeValue) {
            changes.push({
                type:'text',
                old_text:mod_root.text,
                new_text:dom_root.nodeValue.toString(),
                model_node:mod_root,
                dom_node:dom_root
            });
        }
    }
    u.outdent();
    return changes;
}

function selectionToModelNode(info,model) {
    var node = model.findNodeById(info.id);
    info.path.forEach(function(index) {
        node = node.child(index);
    });
    return node;
}

function styleSelectionInline(style) {
    var sel = window.getSelection();
    var range = sel.getRangeAt(0);
    if(range.collapsed) {
        console.log("just change the state");
        return;
    }
    var info = saveSelection(editor);
    var mod = selectionToModelNode(info,model);
    var parts = doc.splitThree(mod,info.startOffset,info.endOffset,model)
    doc.wrapTextInInlineStyle(parts[1],style,model);
    syncDom(editor,model);
    restoreSelection(info);
}

function stopEvent(e) {
    e.preventDefault();
    e.stopPropagation();
}

function findParentBlockDom(elem) {
    var parent = elem.parentElement;
    if(parent.tagName == 'DIV') {
        return parent;
    }
    return null;
}

function changeBlockStyle(style) {
    var sel = window.getSelection();
    var range = sel.getRangeAt(0);
    var block = findParentBlockDom(range.commonAncestorContainer);
    var mod_b = doc.findModelForDom(model.getRoot(),block);
    mod_b.style = style;
    var ran = saveSelection(editor);
    syncDom(editor,model);
    restoreSelection(ran);
}

function splitBlock() {
    var info = saveSelection(editor);
    var mod = selectionToModelNode(info,model);
    var parts = doc.splitBlockAt(mod,info.startOffset,model);
    return parts;
//    return [parts[1],0];
//    syncDom(editor,model);
//    setSelection(parts[1],0,model);
}

function findBlockParent(node) {
    if(node.type ==  doc.BLOCK) return node;
    return findBlockParent(node.parent);
}

function insertStringAt(node, index, str) {
    if(node.type != doc.TEXT) throw new Error("this isn't a text node");
    node.text = node.text.substring(0,index) + str + node.text.substring(index);
}

document.getElementById("editor").addEventListener("input", function(e) {
    console.log("INPUT EVENT");
    var sel = saveSelection(editor);
    var changes = scanForChanges(editor,model.getRoot());
    applyChanges(editor,model,changes);
    syncDom(editor,model);
    restoreSelection(sel);
}, false);

function findModelFromPosition(pos) {
    var node = model.findNodeById(pos.id);
    if(pos.path) pos.path.forEach(function(index) {
        node = node.child(index);
    });
    return node;
}

function textNodeToSelectionPosition(node,offset) {
    var parent = node.getParent();
    var n = parent.content.indexOf(node);
    return {
        id:parent.id,
        path:[n],
        offset:offset
    }
}

function setSelectionFromPosition(pos) {
    if(!pos.id && pos.node != null) {
        pos.id = pos.node;
    }
    if(!pos.id || pos.id == "") {
        console.log("WARNING. bad id");
        return;
    }
    var range = document.createRange();
    console.log("cursor at",pos.id,pos.path,pos.offset);
    var node = document.getElementById(pos.id);
    pos.path.forEach(function(index){
        node = node.childNodes[index];
    });
    range.setStart(node, pos.offset);
    range.collapse(true);
    var wsel = window.getSelection();
    wsel.removeAllRanges();
    wsel.addRange(range);
}

function updateCurrentStyle() {
    setTimeout(function() {
        var info = saveSelection(editor,model);
        var modA = findModelFromPosition(info.startpos);
        var node = modA;
        var styleInfo = {
            type:modA.type,
            id:modA.id,
            node:modA,
            offset:info.startOffset,
            spanStyles:[],
            blockStyles:[]
        };
        while(true) {
            node = node.getParent();
            if(node.getParent() == null) break;
            if(node.type == 'span') {
                styleInfo.spanStyles.push(node.style);
            }
            if(node.type == 'block') {
                styleInfo.blockStyles.push(node.style);
            }
        }
        $("#current-style").html("id: <b>"+styleInfo.id + "</b> offset: <b>" + styleInfo.offset + "</b>"
                +"  span:<b>" +styleInfo.spanStyles.join("") + "</b>  block: <b>" + styleInfo.blockStyles.join("")+"</b>");
    },10);
}



var actions_map = {
    "update-current-style":updateCurrentStyle,
    "style-bold": function(e) {
        stopEvent(e);
        styleSelectionInline(model.getStyles().inline.bold);
    },
    "style-italic": function(e) {
        stopEvent(e);
        styleSelectionInline(model.getStyles().inline.italic);
    },
    "delete-backward":function(e) {
        stopEvent(e);
        var info = saveSelection(editor,model);
        //delete a selection
        if(info.collapsed === false) {
            var modA = findModelFromPosition(info.startpos);
            var modB = findModelFromPosition(info.endpos);
            model.deleteText(modA,info.startpos.offset,
                    modB,info.endpos.offset);
            syncDom(editor,model);
            setSelectionFromPosition(info.startpos);
            return;
        }

        //delete a single char
        var mod = selectionToModelNode(info,model);
        //handle browser bug when block is directly selected
        if(mod.type == doc.BLOCK) {
            if(!mod.isEmpty() && mod.child(0).type == doc.TEXT) {
                mod = mod.child(0);
            }
        }
        var pos = model.deleteTextBackwards(mod,info.startOffset);
        syncDom(editor,model);
        setSelectionFromPosition(textNodeToSelectionPosition(pos.node,pos.offset));
    },
    "delete-forward":function(e) {
        stopEvent(e);
        var info = saveSelection(editor,model);
        var mod = selectionToModelNode(info,model);
        model.deleteTextForwards(mod,info.startOffset);
        syncDom(editor,model);
        restoreSelection(info);
    },
    "style-inline-code":function(e){
        stopEvent(e);
        styleSelectionInline(model.getStyles().inline['inline-code']);
    },
    "style-inline-link":function(e) {
        stopEvent(e);

        var info = saveSelection(editor,model);
        var modA = findModelFromPosition(info.startpos);
        var modB = findModelFromPosition(info.endpos);
        var style = model.getStyles().inline.link;

        console.log('styling selection from ',modA.id,info.startpos.offset,"to",modB.id,info.endpos.offset);
        if(modA != modB) {
            console.log("can't link across blocks");
            return;
        }
        var parts = doc.splitThree(modA,info.startpos.offset,info.endpos.offset,model);
        var span = doc.wrapTextInInlineStyle(parts[1],style,model);
        span.meta = {};
        span.meta.elementName = "A";

        $('#link-modal-text').val(parts[1].text);
        $('#link-modal').modal('show');
        $("#link-modal-submit").click(function(e) {
            $(this).unbind(e);
            $('#link-modal').modal('hide');
            var text = $('#link-modal-text').val();
            var url  = $('#link-modal-url').val();
            span.meta.href = url;
            syncDom(editor,model);
        });
    }
};

document.getElementById('editor').addEventListener('keydown',function(e){
    if(browser_keymap[e.keyCode]) {
        var keyname = browser_keymap[e.keyCode];
        if(e.metaKey && e.shiftKey) {
            var name = "cmd-shift-"+keyname;
            if(key_to_actions[name]) {
                var action = key_to_actions[name];
                if(actions_map[action]) {
                    actions_map[action](e);
                }
                return;
            }
        }
        if(e.metaKey) {
            var name = "cmd-"+keyname;
            if(key_to_actions[name]) {
                var action = key_to_actions[name];
                if(actions_map[action]) {
                    actions_map[action](e);
                }
                return;
            }
        }
        if(e.ctrlKey) {
            var name = "ctrl-"+keyname;
            if(key_to_actions[name]) {
                var action = key_to_actions[name];
                if(actions_map[action]) {
                    actions_map[action](e);
                }
                return;
            }
        }
        var name = ""+keyname;
        if(key_to_actions[name]) {
            var action = key_to_actions[name];
            if(actions_map[action]) {
                actions_map[action](e);
            }
            return;
        }
        return;
    }
    if(e.keyCode == 13) { //enter key
        stopEvent(e);
        var info = saveSelection(editor);
        var mod = findModelFromPosition(info.startpos);
        var block = findBlockParent(mod);
        if(block.style == 'block-code') {
            insertStringAt(mod,info.startOffset,"\n");
            syncDom(editor,model);
            info.startpos.offset++;
            setSelectionFromPosition(info.startpos);
        } else {
            var parts = splitBlock();
            syncDom(editor,model);
            var block2 = findBlockParent(parts[1]);
            setSelectionFromPosition({
                id:block2.id,
                path:[0],
                offset:0,
            });
        }
        return;
    }
});


$("#set-header").click(function(e) {      changeBlockStyle(model.getStyles().block.header);         });
$("#set-subheader").click(function(e) {      changeBlockStyle(model.getStyles().block.subheader);         });
$("#set-body").click(function(e) {        changeBlockStyle(model.getStyles().block.body);           });
$("#set-block-code").click(function(e)  { changeBlockStyle(model.getStyles().block['block-code']);  });
$("#set-block-quote").click(function(e) { changeBlockStyle(model.getStyles().block['block-quote']); });
$("#set-bold").click(function(e) {        styleSelectionInline(model.getStyles().inline.bold);      });
$("#set-italic").click(function(e) {      styleSelectionInline(model.getStyles().inline.italic);    });
$("#set-inline-code").click(function(e) { styleSelectionInline(model.getStyles().inline['inline-code']);  });
$("#set-inline-subscript").click(function(e) { styleSelectionInline(model.getStyles().inline.subscript);  });
$("#set-inline-superscript").click(function(e) { styleSelectionInline(model.getStyles().inline.superscript);  });

$("#switch-visual").click(function() {
    $('#editor')
            .removeClass('semantic-view')
            .removeClass('markdown-view')
            .addClass('visual-view');
});
$("#switch-semantic").click(function() {
    $('#editor')
            .removeClass('visual-view')
            .removeClass('markdown-view')
            .addClass('semantic-view');
});
$("#switch-markdown").click(function() {
    $('#editor')
            .removeClass('visual-view')
            .removeClass('semantic-view')
            .addClass('markdown-view');
});


var saved_info;
$("#set-inline-link").click(function(e) {
    console.log("saved info = ", saved_info);
});


function populateKeyDocs(elem) {
    for(var stroke in key_to_actions) {
        var li = document.createElement("tr");
        li.innerHTML = "<tr><td>"+stroke+"</td><td>" + key_to_actions[stroke]+"</td>";
        elem.appendChild(li);
    }
}
populateKeyDocs(document.getElementById("key-docs"));

</script>
</html>
