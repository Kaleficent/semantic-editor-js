<!--

next up:

add a debug tree to show the model

//move all model manipulation code to separate module. start using browserify
//build unit tests
//description of the data structure and operations


//model nodes have ref to parent. should simplify model manipulation code
//model has function to change style on a node

model has function to load a new model
model has function to fetch model as JSON

make a wrapper function which saves selection, executes action, syncs the dom, then updates selection again

remove duplicate change events. should just be add, delete, and text

implement list support
    switch block type to list item
    enter to make next list item
    switch from numbered to bulleted items
    indent/outdent

implement a model extension for images and other embedded media. forms, etc.

more content types:

-->


<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Semantic Editor</title>

    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.css"/>
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap-theme.css"/>
    <link rel="stylesheet" href="semantic.css"/>
    <link rel="stylesheet" href="visual.css"/>
    <link rel="stylesheet" href="markdown.css"/>
    <style type='text/css'>

#editor {
    border: 1px dotted #ddd;
    padding: 0.5em;
    margin: 1em 0em;
}
#editor:focus {
    outline: none;
    border: 1px solid #ddd;
}

#key-docs {
    border: 1px solid #888;
    border-collapse: collapse;
}
#key-docs td {
    padding: 0.25em 0.25em;
    border: 1px solid #ccc;
}

#model-tree ul {
    padding-left: 2em;
}
#model-tree > ul {
    padding-left: 0;
}

#popup {
    position: absolute;
    top:0;
    left:0;
    border: 1px solid black;
    border-radius: 0.5em;
    background-color: #31b0d5;
    padding: 1em;
}
        #popup h3 {
            padding-top: 0;
            margin-top: 0;
        }

</style>

</head>
<body>

    <div class="container">
        <div class="row">
            <h3>Semantic Editor</h3>
        </div>
        <div class="row">
            <div class="col-md-3">
                <h3>Shortcuts</h3>
                <table id="key-docs"></table>
            </div>
            <div class="col-md-6">
                <div class="row">
                    <div class="col-md-12">
                        <div class="btn-group">
                            <button id="foo" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Block <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a href="#" id="set-header">Header</a></li>
                                <li><a href="#" id="set-subheader">Subheader</a></li>
                                <li><a href="#" id="set-body">Plain Body</a></li>
                                <li><a href="#" id="set-block-code">Code Block</a></li>
                                <li><a href="#" id="set-block-quote">Quote</a></li>
                                <li><a href="#" id="set-list-item">List Item</a></li>
                                <li role="separator" class="divider"></li>
                                <li><a href="#" id="set-custom">Custom</a></li>
                            </ul>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Span <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a href="#" id="set-plain">Plain</a></li>
                                <li><a href="#" id="set-bold">Bold</a></li>
                                <li><a href="#" id="set-italic">Italic</a></li>
                                <li><a href="#" id="set-inline-code">Code</a></li>
                                <li><a href="#" id="set-inline-link">Link</a></li>
                                <li><a href="#" id="set-inline-subscript">Subscript</a></li>
                                <li><a href="#" id="set-inline-superscript">Superscript</a></li>
                                <li><a href="#" id="set-deleted">Deleted</a></li>
                                <li role="separator" class="divider"></li>
                                <li><a href="#" id="set-custom-inline">Custom</a></li>
                            </ul>
                        </div>
                        <div class="btn-group">
                            <button id='switch-semantic' type="button" class="btn btn-default">Semantic</button>
                            <button id='switch-visual' type="button" class="btn btn-default">Visual</button>
                            <button id='switch-markdown' type="button" class="btn btn-default">Markdown</button>
                        </div>
                    </div>
                </div>
                <div id="current-style">current style</div>
                <div id="editor" class="semantic-view" contenteditable="true" spellcheck="false"></div>
            </div>
            <div class="col-md-3">
                <h3>Tree Structure</h3>
                <div id="model-tree"></div>
            </div>
        </div>
    </div>


    <div id="popup" class="hidden">
        <h3>Emoji</h3>
        <table>
            <tr><td><a id="emoji1">&#x1F4A9</a></td></tr>
            <tr><td><a id="emoji2">&#x1F4A3</a></td></tr>
        </table>
    </div>
    <div class="modal fade" id="link-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Edit Link</h4>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label>Text</label> <input type="text" class="form-control" id="link-modal-text"/>
                            <label>Link</label> <input type="text" class="form-control" id="link-modal-url"/>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="link-modal-submit">Insert</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

</body>
<script src="node_modules/jquery/dist/jquery.js"></script>
<script src="node_modules/bootstrap/dist/js/bootstrap.js"></script>
<script src="node_modules/punycode/punycode.js"></script>
<script src="bundle.js"></script>
<script type='text/javascript'>

var doc = require('model');
var dom = require('dom');

var model = doc.makeModel();
model.setStyles({
    block:{
        //name of style : css classname
        header:'header',
        subheader:'subheader',
        body:'body',
        'block-code':'block-code',
        'block-quote':'block-quote'
    },
    inline: {
        bold:'bold',
        italic:'italic',
        'inline-code':'inline-code',
        link:'link',
        subscript:'subscript',
        superscript:'superscript'
    }
});


var browser_keymap = {
    8:"backspace",
    13:"enter",
    37:"arrow-left",
    39:"arrow-right",
    38:"arrow-up",
    40:"arrow-down",
    65:"a",
    66:"b",
    67:"c",
    68:"d",
    69:"e",
    73:"i"
};

var key_to_actions = {
    "arrow-left": "update-current-style",
    "arrow-right": "update-current-style",
    "arrow-up": "update-current-style",
    "arrow-down": "update-current-style",
    "ctrl-d":"delete-forward",
    "cmd-b":"style-bold",
    "backspace":"delete-backward",
    "cmd-i":"style-italic",
    "cmd-shift-c":"style-inline-code",
    "cmd-shift-a":"style-inline-link",
    "cmd-shift-e":"insert-emoji"
};


var block1 = model.makeBlock();
model.setBlockStyle(block1,'header');
var text1 = model.makeText("This is a header");
block1.append(text1);
var text2 = model.makeText(" with some");
block1.append(text2);
var text3 = model.makeText(" text");
block1.append(text3);
model.getRoot().append(block1);

var block2 = model.makeBlock();
model.getRoot().append(block2);
model.setBlockStyle(block2,'body');
block2.append(model.makeText("This is a paragraph of body text"));


var span1 = model.makeSpan();
span1.style = 'bold';
span1.append(model.makeText(" with some bold"));
block2.append(span1);

var span2 = model.makeSpan();
span2.style = 'italic';
span2.append(model.makeText(" and italic"));
block2.append(span2);

block2.append(model.makeText(" text to read."));
block2.append(model.makeText(" And now some more text that we will read and read and it just goes on and on."));

var block3 = model.makeBlock();
model.getRoot().append(block3);
model.setBlockStyle(block3,'body');
block3.append(model.makeText("This is another paragraph of body text"));

var block3 = model.makeBlock();
model.getRoot().append(block3);
model.setBlockStyle(block3,'block-code');
block3.append(model.makeText("//codeblock\nfor(var i=0; i<8; i++) {\n  console.log(i);\n}"));

var editor = document.getElementById('editor');
dom.syncDom(editor,model);



function styleSelectionInline(style) {
    var sel = window.getSelection();
    var range = sel.getRangeAt(0);
    if(range.collapsed) {
        console.log("just change the state");
        return;
    }
    var info = dom.saveSelection(model);
    var mod = dom.selectionToModelNode(info,model);
    var parts = doc.splitThree(mod,info.startOffset,info.endOffset,model)
    doc.wrapTextInInlineStyle(parts[1],style,model);
    dom.syncDom(editor,model);
    dom.restoreSelection(info);
}

function stopEvent(e) {
    e.preventDefault();
    e.stopPropagation();
}

function changeBlockStyle(style) {
    var sel = window.getSelection();
    var range = sel.getRangeAt(0);
    var block = dom.findParentBlockDom(range.commonAncestorContainer);
    var mod_b = doc.findModelForDom(model.getRoot(),block);
    mod_b.style = style;
    var ran = dom.saveSelection(model);
    dom.syncDom(editor,model);
    dom.restoreSelection(ran);
}

function splitBlock() {
    var info = dom.saveSelection(model);
    var mod = dom.selectionToModelNode(info,model);
    return doc.splitBlockAt(mod,info.startOffset,model);
}

function insertStringAt(node, index, str) {
    if(node.type != doc.TEXT) throw new Error("this isn't a text node");
    node.text = node.text.substring(0,index) + str + node.text.substring(index);
}

document.getElementById("editor").addEventListener("input", function(e) {
    console.log("INPUT EVENT");
    var sel = dom.saveSelection(model);
    var changes = dom.scanForChanges(editor,model.getRoot());
    dom.applyChanges(editor,model,changes);
    dom.syncDom(editor,model);
    dom.restoreSelection(sel);
}, false);


function updateCurrentStyle() {
    setTimeout(function() {
        var info = dom.saveSelection(model);
        var modA = dom.findModelFromPosition(info.startpos);
        var node = modA;
        var styleInfo = {
            type:modA.type,
            id:modA.id,
            node:modA,
            offset:info.startOffset,
            spanStyles:[],
            blockStyles:[]
        };
        while(true) {
            node = node.getParent();
            if(node.getParent() == null) break;
            if(node.type == 'span') {
                styleInfo.spanStyles.push(node.style);
            }
            if(node.type == 'block') {
                styleInfo.blockStyles.push(node.style);
            }
        }
        $("#current-style").html("id: <b>"+styleInfo.id + "</b> offset: <b>" + styleInfo.offset + "</b>"
                +"  span:<b>" +styleInfo.spanStyles.join("") + "</b>  block: <b>" + styleInfo.blockStyles.join("")+"</b>");
    },10);
}
var saved_info;



var actions_map = {
    "update-current-style":updateCurrentStyle,
    "style-bold": function(e) {
        stopEvent(e);
        styleSelectionInline(model.getStyles().inline.bold);
    },
    "style-italic": function(e) {
        stopEvent(e);
        styleSelectionInline(model.getStyles().inline.italic);
    },
    "delete-backward":function(e) {
        stopEvent(e);
        var info = dom.saveSelection(model);
        //delete a selection
        if(info.collapsed === false) {
            var modA = dom.findModelFromPosition(info.startpos);
            var modB = dom.findModelFromPosition(info.endpos);
            model.deleteText(modA,info.startpos.offset,
                    modB,info.endpos.offset);
            dom.syncDom(editor,model);
            dom.setSelectionFromPosition(info.startpos);
            return;
        }

        //delete a single char
        var mod = dom.selectionToModelNode(info,model);
        //handle browser bug when block is directly selected
        if(mod.type == doc.BLOCK) {
            if(!mod.isEmpty() && mod.child(0).type == doc.TEXT) {
                mod = mod.child(0);
            }
        }
        var pos = model.deleteTextBackwards(mod,info.startOffset);
        dom.syncDom(editor,model);
        dom.setSelectionFromPosition(dom.textNodeToSelectionPosition(pos.node,pos.offset));
    },
    "delete-forward":function(e) {
        stopEvent(e);
        var info = dom.saveSelection(model);
        var mod = dom.selectionToModelNode(info,model);
        model.deleteTextForwards(mod,info.startOffset);
        dom.syncDom(editor,model);
        dom.restoreSelection(info);
    },
    "style-inline-code":function(e){
        stopEvent(e);
        styleSelectionInline(model.getStyles().inline['inline-code']);
    },
    "style-inline-link":function(e) {
        stopEvent(e);

        var info = dom.saveSelection(model);
        var modA = dom.findModelFromPosition(info.startpos);
        var modB = dom.findModelFromPosition(info.endpos);
        var style = model.getStyles().inline.link;

        if(modA != modB) {
            console.log("can't link across blocks");
            return;
        }
        var parts = doc.splitThree(modA,info.startpos.offset,info.endpos.offset,model);
        var span = doc.wrapTextInInlineStyle(parts[1],style,model);
        span.meta = {};
        span.meta.elementName = "A";

        $('#link-modal-text').val(parts[1].text);
        $('#link-modal').modal('show');
        $("#link-modal-submit").click(function(e) {
            $(this).unbind(e);
            $('#link-modal').modal('hide');
            var text = $('#link-modal-text').val();
            var url  = $('#link-modal-url').val();
            span.meta.href = url;
            dom.syncDom(editor,model);
        });
    },
    "insert-emoji": function(e) {
        stopEvent(e);


        saved_info = dom.saveSelection(model);

        var xy = dom.getCaretClientPosition();
        $("#popup").removeClass("hidden");
        $("#popup").offset({left:xy.x,top:xy.y});
    }
};


$("#emoji1").click(function(e) {
    $("#popup").addClass('hidden');
    var modA = dom.findModelFromPosition(saved_info.startpos);
    var str = punycode.ucs2.encode([ 0x1F4A9 ]);
    modA.text = modA.text.substring(0,saved_info.startpos.offset)
            + str
            + modA.text.substring(saved_info.startpos.offset);
    dom.syncDom(editor,model);
    dom.restoreSelection(saved_info);
});
$("#emoji2").click(function(e) {
    $("#popup").addClass('hidden');
    var str = punycode.ucs2.encode([ 0x1F4A3 ]);
    var modA = dom.findModelFromPosition(saved_info.startpos);
    modA.text = modA.text.substring(0,saved_info.startpos.offset)
            + str
            + modA.text.substring(saved_info.startpos.offset);
    dom.syncDom(editor,model);
    dom.restoreSelection(saved_info);
});

document.getElementById('editor').addEventListener('keydown',function(e){
    if(e.keyCode == 13) { //enter key
        stopEvent(e);
        var info = dom.saveSelection(model);
        var mod = dom.findModelFromPosition(info.startpos);
        var block = dom.findBlockParent(mod);
        if(block.style == 'block-code') {
            insertStringAt(mod,info.startOffset,"\n");
            dom.syncDom(editor,model);
            info.startpos.offset++;
            dom.setSelectionFromPosition(info.startpos);
        } else {
            var parts = splitBlock();
            dom.syncDom(editor,model);
            var block2 = dom.findBlockParent(parts[1]);
            dom.setSelectionFromPosition({
                id:block2.id,
                path:[0],
                offset:0,
            });
        }
        return;
    }
    if(browser_keymap[e.keyCode]) {
        var keyname = browser_keymap[e.keyCode];
        if(e.metaKey && e.shiftKey) {
            var name = "cmd-shift-"+keyname;
            if(key_to_actions[name]) {
                var action = key_to_actions[name];
                if(actions_map[action]) {
                    actions_map[action](e);
                }
                return;
            }
        }
        if(e.metaKey) {
            var name = "cmd-"+keyname;
            if(key_to_actions[name]) {
                var action = key_to_actions[name];
                if(actions_map[action]) {
                    actions_map[action](e);
                }
                return;
            }
        }
        if(e.ctrlKey) {
            var name = "ctrl-"+keyname;
            if(key_to_actions[name]) {
                var action = key_to_actions[name];
                if(actions_map[action]) {
                    actions_map[action](e);
                }
                return;
            }
        }
        var name = ""+keyname;
        if(key_to_actions[name]) {
            var action = key_to_actions[name];
            if(actions_map[action]) {
                actions_map[action](e);
            }
            return;
        }
        return;
    }
});


$("#set-header").click(function(e) {      changeBlockStyle(model.getStyles().block.header);         });
$("#set-subheader").click(function(e) {      changeBlockStyle(model.getStyles().block.subheader);         });
$("#set-body").click(function(e) {        changeBlockStyle(model.getStyles().block.body);           });
$("#set-block-code").click(function(e)  { changeBlockStyle(model.getStyles().block['block-code']);  });
$("#set-block-quote").click(function(e) { changeBlockStyle(model.getStyles().block['block-quote']); });
$("#set-bold").click(function(e) {        styleSelectionInline(model.getStyles().inline.bold);      });
$("#set-italic").click(function(e) {      styleSelectionInline(model.getStyles().inline.italic);    });
$("#set-inline-code").click(function(e) { styleSelectionInline(model.getStyles().inline['inline-code']);  });
$("#set-inline-subscript").click(function(e) { styleSelectionInline(model.getStyles().inline.subscript);  });
$("#set-inline-superscript").click(function(e) { styleSelectionInline(model.getStyles().inline.superscript);  });

$("#switch-visual").click(function() {
    $('#editor')
            .removeClass('semantic-view')
            .removeClass('markdown-view')
            .addClass('visual-view');
});
$("#switch-semantic").click(function() {
    $('#editor')
            .removeClass('visual-view')
            .removeClass('markdown-view')
            .addClass('semantic-view');
});
$("#switch-markdown").click(function() {
    $('#editor')
            .removeClass('visual-view')
            .removeClass('semantic-view')
            .addClass('markdown-view');
});


$("#set-inline-link").click(function(e) {
    console.log("saved info = ", saved_info);
});


function populateKeyDocs(elem) {
    for(var stroke in key_to_actions) {
        var li = document.createElement("tr");
        li.innerHTML = "<tr><td>"+stroke+"</td><td>" + key_to_actions[stroke]+"</td>";
        elem.appendChild(li);
    }
}
populateKeyDocs(document.getElementById("key-docs"));

</script>
</html>
