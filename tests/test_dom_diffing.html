<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <link rel="stylesheet" href="../semantic.css">
    <style type="text/css">
        .semantic-view {
            border: 1px solid red;
        }
        .semantic-view {
            margin-right: 30em;
        }
        #model-tree {
            position: absolute;
            right: 0;
            top: 0;
            width: 25em;
            border: 1px solid red;
        }
    </style>

</head>
<body>
<div id="editor" class="semantic-view" contenteditable="true" spellcheck="false"></div>
<div id="model-tree"></div>
</body>
<script src="../bundle.js"></script>
<script type='text/javascript'>
var Model = require('model');
var Dom = require('dom');
var Keystrokes = require('keystrokes');

function setupSpanTest() {
    var model = Model.makeModel();
    var block1 = model.makeBlock();
    var text1  = model.makeText("abc");
    block1.append(text1);
    var span = model.makeSpan();
    span.style = 'bold';
    var text2 = model.makeText('def');
    span.append(text2);
    block1.append(span);
    var text3 = model.makeText('ghi');
    block1.append(text3);
    model.getRoot().append(block1);
    return model;
}
function setupModel() {
    var model = Model.makeModel();
    var block0 = model.makeBlock();
    block0.append(model.makeText("ABC"));
    model.getRoot().append(block0);
    var block = model.makeBlock();
    model.getRoot().append(block);
    var span = model.makeSpan();
    span.style = 'italic';
    block.append(model.makeText("xxx"));
    span.append(model.makeText("def"));
    block.append(span);
    block.append(model.makeText("ghi"));

    var ul = model.makeBlock();
    ul.style = 'unordered-list';
    var li1 = model.makeBlock();
    li1.style = 'list-item';
    li1.append(model.makeText("list item 1"));
    ul.append(li1);
    var li2 = model.makeBlock();
    li2.style = 'list-item';
    li2.append(model.makeText("list item 2"));
    ul.append(li2);
    model.getRoot().append(ul);

    var img = model.makeSpan();
    img.style = 'image';
    img.meta = {
        src: './earth.jpg'
    };
    var block3 = model.makeBlock();
    block3.append(img);
    model.getRoot().append(block3);
    return model;
}
//var model = setupModel();
var model = setupSpanTest();

var dom_root = document.getElementById("editor");
dom_root.id = model.getRoot().id;
Dom.modelToDom(model,dom_root,document);
Keystrokes.setModel(model);
Keystrokes.setEditor(dom_root);

dom_root.addEventListener("input", function(e){
    var sel = window.getSelection();
    var range = sel.getRangeAt(0);
    var start_dom = range.startContainer;
    var start_off = range.startOffset;
    var ssel = {
        start_node:start_dom,
        start_offset:start_off
    };
    var range = Dom.calculateChangeRange(model,dom_root,ssel);
    var changes = Dom.calculateChangeList(range);

    Dom.applyChanges(changes,model);
    var com_mod = Dom.findCommonParent(range.start.mod,range.end.mod);
    var com_dom = Dom.findDomForModel(com_mod,dom_root);
    Dom.rebuildDomFromModel(com_mod,com_dom,dom_root, document);
    renderModelTree(model,document.getElementById("model-tree"));
});

function stop(e) {
    if(e.preventDefault) {
        e.preventDefault();
        e.stopPropagation();
    }
}


dom_root.addEventListener("keydown", function(e) {
    Keystrokes.handleEvent(e);
});

Keystrokes.on("change",function(){
    console.log("stuff has changed");
    renderModelTree(model,document.getElementById("model-tree"));
});


renderModelTree(model, document.getElementById("model-tree"));

function renderModelTree(model,dom) {
    if(model.getRoot) {
        dom.innerHTML = "<ul>"+model.getRoot().content.map(renderModelTree).join("")+"</ul>";
    }

    if(model.type == Model.TEXT) {
        return "<li><b>"+model.id+"</b>text: <i>"+model.text+"</i></li>";
    }
    if(model.type == Model.BLOCK || model.type == Model.SPAN) {
        return "<li><b>"+model.type+"#"+model.id+"."+model.style+"</b><ul>"+model.content.map(renderModelTree).join("")+"</ul></li>";
    }
}


</script>
</html>