<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <link rel="stylesheet" href="../semantic.css">
    <style type="text/css">
        .semantic-view {
            border: 1px solid red;
        }
        .semantic-view {
            margin-right: 30em;
        }
        #model-tree {
            position: absolute;
            right: 0;
            top: 0;
            width: 25em;
            border: 1px solid red;
        }
    </style>

</head>
<body>
<div id="editor" class="semantic-view" contenteditable="true" spellcheck="false"></div>
<div id="model-tree"></div>
</body>
<script src="../bundle.js"></script>
<script type='text/javascript'>
var Model = require('model');
var Dom = require('dom');
var Keystrokes = require('keystrokes');

var model = Model.makeModel();
var block0 = model.makeBlock();
block0.append(model.makeText("ABC"));
model.getRoot().append(block0);
var block = model.makeBlock();
model.getRoot().append(block);
//block.append(model.makeText("abc"));
var span = model.makeSpan();
span.style = 'italic';
span.append(model.makeText("def"));
block.append(span);
block.append(model.makeText("ghi"));

var dom_root = document.getElementById("editor");
dom_root.id = model.getRoot().id;
Dom.modelToDom(model,dom_root,document);

dom_root.addEventListener("input", function(e){
    console.log("event",e);
    var sel = window.getSelection();
    console.log(sel);
    var range = sel.getRangeAt(0);
    console.log("range = ", range);
    var start_dom = range.startContainer;
    var start_off = range.startOffset;
    var ssel = {
        start_node:start_dom,
        start_offset:start_off
    };
    var range = Dom.calculateChangeRange(model,dom_root,ssel);
    console.log("change range = ", range);
    var changes = Dom.calculateChangeList(range);
    console.log("changes = ", changes);
    console.log(changes.map(function(ch) {
        return ch.mod.text + " => "
    }).join(" "));

    Dom.applyChanges(changes,model);
    var com_mod = Dom.findCommonParent(range.start.mod,range.end.mod);
    var com_dom = Dom.findDomForModel(com_mod,dom_root);
    Dom.rebuildDomFromModel(com_mod,com_dom,dom_root, document);
    renderModelTree(model,document.getElementById("model-tree"));
});

function stop(e) {
    if(e.preventDefault) {
        e.preventDefault();
        e.stopPropagation();
    }
}

Keystrokes.actions_map["delete-backward"] = function(e) {
    stop(e);
    if(window.getSelection().getRangeAt(0).collapsed === false) {
        var range = makeRangeFromSelection(model, window);
    } else {
        var range = makeRangeFromSelection(model, window);
        range.start.offset--;
        if(range.start.offset < 0) {
            var prevtext = model.getPreviousTextNode(range.start.mod);
            range.start.mod = prevtext;
            range.start.offset = prevtext.text.length;
        }
    }

    var changes = Dom.makeDeleteTextRange(range,model);
    var com_mod = Dom.findCommonParent(range.start.mod,range.end.mod);
    Dom.applyChanges(changes,model);
    renderModelTree(model,document.getElementById("model-tree"));
    var com_dom = Dom.findDomForModel(com_mod,dom_root);
    Dom.rebuildDomFromModel(com_mod,com_dom,dom_root, document);
};

Keystrokes.actions_map["delete-forward"] = function(e) {
    stop(e);
    if(window.getSelection().getRangeAt(0).collapsed === false) {
        var range = makeRangeFromSelection(model, window);
    } else {
        var range = makeRangeFromSelection(model, window);
        range.end.offset++;
        if(range.end.offset > range.end.mod.text.length) {
            var nexttext = model.getNextTextNode(range.end.mod);
            range.end.mod = nexttext;
            range.end.offset = 0;
        }
    }

    var changes = Dom.makeDeleteTextRange(range,model);
    var com_mod = Dom.findCommonParent(range.start.mod,range.end.mod);
    Dom.applyChanges(changes,model);
    renderModelTree(model,document.getElementById("model-tree"));
    var com_dom = Dom.findDomForModel(com_mod,dom_root);
    Dom.rebuildDomFromModel(com_mod,com_dom,dom_root, document);
};

function makeRangeFromSelection(model,window) {
    var selection = window.getSelection().getRangeAt(0);
    var range = {
        start: {
            dom: selection.startContainer,
            mod: Dom.findModelForDom(model, selection.startContainer),
            offset: selection.startOffset
        },
        end: {
            dom: selection.endContainer,
            mod: Dom.findModelForDom(model, selection.endContainer),
            offset: selection.endOffset
        }
    };
    return range;
}
Keystrokes.actions_map['style-bold'] = function(e) {
    console.log("styling to be bold");
    if(e.preventDefault) {
        e.preventDefault();
        e.stopPropagation();
    }
    var range = makeRangeFromSelection(model,window);
    var changes = Dom.makeStyleTextRange(range,model,'bold');
    var com_mod = range.start.mod.getParent();
    Dom.applyChanges(changes,model);
    renderModelTree(model,document.getElementById("model-tree"));
    var com_dom = Dom.findDomForModel(com_mod,dom_root);
    Dom.rebuildDomFromModel(com_mod,com_dom,dom_root, document);
};

Keystrokes.actions_map['style-italic'] = function(e) {
    console.log("styling to be italic");
    if(e.preventDefault) {
        e.preventDefault();
        e.stopPropagation();
    }
    var range = makeRangeFromSelection(model,window);
    var changes = Dom.makeStyleTextRange(range,model,'italic');
    var com_mod = range.start.mod.getParent();
    Dom.applyChanges(changes,model);
    renderModelTree(model,document.getElementById("model-tree"));
    var com_dom = Dom.findDomForModel(com_mod,dom_root);
    Dom.rebuildDomFromModel(com_mod,com_dom,dom_root, document);
};

dom_root.addEventListener("keydown", function(e) {
    Keystrokes.handleEvent(e);
});

renderModelTree(model, document.getElementById("model-tree"));

function renderModelTree(model,dom) {
    if(model.getRoot) {
        dom.innerHTML = "<ul>"+model.getRoot().content.map(renderModelTree).join("")+"</ul>";
    }

    if(model.type == Model.TEXT) {
        return "<li><b>"+model.id+"</b>text: <i>"+model.text+"</i></li>";
    }
    if(model.type == Model.BLOCK || model.type == Model.SPAN) {
        return "<li><b>"+model.type+"#"+model.id+"."+model.style+"</b><ul>"+model.content.map(renderModelTree).join("")+"</ul></li>";
    }
}


</script>
</html>